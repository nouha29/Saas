{{ include('partials/main.html.twig') }}
<head>
  {{ include('partials/title-meta.html.twig', {title: 'Statistiques - Générale'}) }}


  {{ include('partials/head-css.html.twig') }}
</head>
<body>
<div id="layout-wrapper">
  {{ include('partials/menu.html.twig') }}
  <div class="main-content">
    <div class="page-content"><div class="container-fluid">

      <h4 class="mb-3">Statistiques — Générale</h4>
      {% if currentMonth %}
  <div class="mb-3">
    <span class="badge bg-secondary">Période affichée : {{ currentMonth }}</span>
  </div>
{% endif %}

  <form method="get" class="mb-3 d-flex align-items-center" id="monthFilter">
  <label class="me-2 mb-0 text-muted" for="month">Période :</label>
  <input type="month" name="month" id="month"
         value="{{ app.request.query.get('month') ?? (date()|date('Y-m')) }}"
         class="form-control" style="max-width:220px;">
  <button class="btn btn-primary ms-2">Appliquer</button>
  {% if app.request.query.get('month') %}
    <a href="{{ app.request.pathinfo }}" class="btn btn-link ms-2">Mois courant</a>
  {% endif %}
</form>

      <div class="row g-3">
        <div class="col-xl-3 col-md-6"><div class="card"><div class="card-body">
          <p class="text-muted mb-1">CA Mensuel (HT)</p>
          <h4 class="mb-0">{{ caMensuel|number_format(2,'.',' ') }} TND</h4>
        </div></div></div>
        <div class="col-xl-3 col-md-6"><div class="card"><div class="card-body">
          <p class="text-muted mb-1">Dépenses Mensuelles (HT)</p>
          <h4 class="mb-0">{{ depMensuelles|number_format(2,'.',' ') }} TND</h4>
        </div></div></div>
        <div class="col-xl-3 col-md-6"><div class="card"><div class="card-body">
          <p class="text-muted mb-1">Valeur Stock</p>
          <h4 class="mb-0">{{ valStock|number_format(2,'.',' ') }} TND</h4>
        </div></div></div>
        <div class="col-xl-3 col-md-6"><div class="card"><div class="card-body">
          <p class="text-muted mb-1">Docs créés (mois)</p>
          <h4 class="mb-0">{{ nbDocsMensuel }}</h4>
        </div></div></div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-xl-8"><div class="card"><div class="card-body">
          <h6 class="mb-3">Répartition des documents (mois)</h6>
          <div id="chartDocsType" style="min-height:300px"></div>
        </div></div></div>
        <div class="col-xl-4"><div class="card"><div class="card-body">
          <h6 class="mb-3">Top utilisateurs (mois)</h6>
          <ol class="mb-0">
            {% for u in topUsers %}
              <li>Utilisateur #{{ u.user_id }} — <strong>{{ u.nb }}</strong> docs</li>
            {% else %}
              <li class="text-muted">Aucune donnée</li>
            {% endfor %}
          </ol>
        </div></div></div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-xl-6">
          <div class="card"><div class="card-body">
            <h6 class="mb-3">Top 5 Clients par CA</h6>
            <table class="table table-sm">
              <thead><tr><th>#</th><th>Client</th><th class="text-end">CA (HT)</th></tr></thead>
              <tbody>
                {% for c in topClients %}
                  <tr><td>{{ c.customer_name ?? ('#' ~ c.customer_id) }}</td><td class="text-end">{{ c.ca|number_format(2,'.',' ') }}</td></tr>
                {% else %}
                  <tr><td colspan="3" class="text-muted text-center">Aucune donnée</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div></div>
        </div>
        <div class="col-xl-6">
          <div class="card"><div class="card-body">
            <h6 class="mb-3">Top 5 Fournisseurs</h6>
            <table class="table table-sm">
              <thead><tr><th>#</th><th>Fournisseur</th><th class="text-end">Achats (HT)</th></tr></thead>
              <tbody>
                {% for f in topFournisseurs %}
                  <tr><td>{{ f.supplier_name ?? ('#' ~ f.supplier_id) }}</td><td class="text-end">{{ f.total|number_format(2,'.',' ') }}</td></tr>
                {% else %}
                  <tr><td colspan="3" class="text-muted text-center">Aucune donnée</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div></div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12">
          <div class="card"><div class="card-body">
            <h6 class="mb-3">Articles en rupture</h6>
            <table class="table table-sm">
              <thead><tr><th>ID</th><th>Article</th><th class="text-end">Qté</th><th class="text-end">Seuil</th></tr></thead>
              <tbody>
                {% for a in ruptures %}
                  <tr class="table-warning"><td>{{ a.id }}</td><td>{{ a.name }}</td><td class="text-end">{{ a.qty }}</td><td class="text-end">{{ a.reorder_threshold }}</td></tr>
                {% else %}
                  <tr><td colspan="4" class="text-muted text-center">Aucune rupture</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div></div>
        </div>
      </div>

    </div></div>
    {{ include('partials/footer.html.twig') }}
  </div>
</div>

{{ include('partials/vendor-scripts.html.twig') }}
<script src="{{ asset('assets/libs/apexcharts/apexcharts.min.js') }}"></script>
<script>
(async () => {
  const res = await fetch('{{ path("api_stats_docs_repartition") }}');
  const data = await res.json(); // [{label, value}]
  const options = {
    chart:{ type:'donut', height:300 },
    series: data.map(d=>d.value),
    labels: data.map(d=>d.label),
    legend:{ position:'bottom' }
  };
  new ApexCharts(document.querySelector('#chartDocsType'), options).render();
})();
</script>
</body>
</html>
