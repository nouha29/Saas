{% form_theme form 'bootstrap_5_layout.html.twig' %}

<div class="card-body border-bottom border-bottom-dashed p-4">
	<div class="row">
		<div class="col-lg-12">
			{{ form_row(form.produit, {
                'attr': {'class': 'form-select'},
                'label': 'Produit Fini'
            }) }}
		</div>
	</div>
</div>

<div class="card-body p-4">
	<h5 class="mb-3">Composition du produit</h5>
	<div class="table-responsive">
		<table class="table table-borderless table-nowrap mb-0" id="composition-table">
			<thead class="table-light">
				<tr>
					<th>Matière Première</th>
					<th>Consommation</th>
					<th>Unité</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="composition-lignes" data-prototype="{{ form_widget(form.composition.vars.prototype)|e('html_attr') }}" data-index="{{ form.composition|length }}">
				{% for ligne in form.composition %}
					<tr class="composition-row">
						<td>{{ form_widget(ligne.matiere, {'attr': {'class': 'form-select'}}) }}</td>
						<td>{{ form_widget(ligne.consommation, {'attr': {'class': 'form-control'}}) }}</td>
						<td>{{ ligne.vars.value.matiere.vars.value.unite }}</td>
						<td>
							<button type="button" class="btn btn-sm btn-danger remove-ligne">
								<i class="ri-delete-bin-line"></i>
							</button>
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<button type="button" id="add-ligne" class="btn btn-soft-secondary fw-medium mt-3">
		<i class="ri-add-fill me-1 align-bottom"></i>
		Ajouter une matière
	</button>
</div>

<div class="card-body p-4 border-top border-top-dashed">
	<div class="hstack gap-2 justify-content-end">
		<button type="submit" class="btn btn-success">
			<i class="ri-save-line align-bottom me-1"></i>
			{{ button_label|default('Enregistrer') }}
		</button>
		<a href="{{ path('app_nomenclature_index') }}" class="btn btn-light">
			Annuler
		</a>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
const lignesContainer = document.getElementById('composition-lignes');
const addButton = document.getElementById('add-ligne');
let index = parseInt(lignesContainer.dataset.index);

addButton.addEventListener('click', function () {
const prototype = lignesContainer.dataset.prototype;
const newRow = document.createElement('tr');
newRow.className = 'composition-row';
newRow.innerHTML = prototype.replace(/__name__/g, index);

const deleteCell = document.createElement('td');
deleteCell.innerHTML = `
                <button type="button" class="btn btn-sm btn-danger remove-ligne">
                    <i class="ri-delete-bin-line"></i>
                </button>
            `;
newRow.appendChild(deleteCell);

lignesContainer.appendChild(newRow);
index++;
lignesContainer.dataset.index = index;

newRow.querySelector('.remove-ligne').addEventListener('click', function () {
newRow.remove();
});
});

document.querySelectorAll('.remove-ligne').forEach(button => {
button.addEventListener('click', function () {
this.closest('tr').remove();
});
});
});
</script>
